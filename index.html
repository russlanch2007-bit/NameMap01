<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> :--==++*++==--:       --==++**##**++==--        :--==++**##**++==--:
--==++**##**++==--    .==++**####**++==.        --==++**####**++==--
==++**####**++==.     :++**######**++:          ==++**######**++==.
++**######**++:       .+*########*+.           ++**########**++:
*##########*+          :*########*:            *###########**+
*##########*:           +########+             *############*+
+##########+            .*######*.             +############*+
:*########*:             :*####*:              :*###########+:
 .+######+.               .+##+.                .+#########+.
  :*####*:                 .++:                  :*#######*:
   .+##+.                   ..                    .+#####+.
    .++:                                            :*###*:
     ..                                              .+##+.
                                                      :++:
                                                       ..

    ..::
</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: black;
            color: lime;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
        }
        
        .header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 10px 20px;
        }
        
        .header h1 {
            font-size: 24px;
            text-shadow: 0 0 10px lime;
        }
        
        #canvasContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            cursor: grab;
        }
        
        #canvasContainer:active {
            cursor: grabbing;
        }
        
        #canvas {
            position: absolute;
            width: 5000px;
            height: 5000px;
            background: black;
        }
        
        .nickname {
            position: absolute;
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.7);
            color: lime;
            border: 2px solid lime;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 0 15px lime;
            max-width: 300px;
            word-wrap: break-word;
            text-align: center;
            line-height: 1.4;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .donut-btn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            background: white;
            color: black;
            border: 2px solid lime;
            border-radius: 5px;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 20px lime;
        }
        
        .donut-btn:hover {
            background: lime;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –≥–æ–ª–æ–≥—Ä–∞–º–º—ã */
        @keyframes hologramGlow {
            0% { box-shadow: 0 0 5px lime, 0 0 10px lime; }
            50% { box-shadow: 0 0 20px lime, 0 0 40px lime; }
            100% { box-shadow: 0 0 5px lime, 0 0 10px lime; }
        }
        
        .hologram {
            animation: hologramGlow 3s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>NAME MAP</h1>
    </div>
    
    <div id="canvasContainer">
        <div id="canvas">
            <!-- –ù–∏–∫–Ω–µ–π–º—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
    </div>
    
    <button class="donut-btn" id="donutButton">üç© DONUT 1‚ÇΩ</button>
    
    <script>
    // ===== –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ =====
    
    // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const canvas = document.getElementById('canvas');
    const container = document.getElementById('canvasContainer');
    const donutButton = document.getElementById('donutButton');
    
    // 1. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
    let isDragging = false;
    let startX, startY;
    let canvasLeft = 0, canvasTop = 0;
    
    container.addEventListener('mousedown', function(e) {
        if (e.target === donutButton) return;
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        canvasLeft = parseInt(canvas.style.left) || 0;
        canvasTop = parseInt(canvas.style.top) || 0;
        container.style.cursor = 'grabbing';
    });
    
    document.addEventListener('mouseup', () => {
        isDragging = false;
        container.style.cursor = 'grab';
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        canvas.style.left = (canvasLeft + deltaX) + 'px';
        canvas.style.top = (canvasTop + deltaY) + 'px';
    });
    
    // 2. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä ID
    function generateID() {
        return 'NICK_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
    }
    
    // 3. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    async function updateNickPositionOnServer(id, x, y) {
        try {
            await fetch('/api/update-nick-position', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, x, y })
            });
            console.log(`–ü–æ–∑–∏—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è ${id}`);
        } catch (error) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é:', error);
        }
    }
    
    // 4. –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–ø–∏—Ä–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
    function arrangeNicksInSpiral() {
        const nicks = document.querySelectorAll('.nickname');
        console.log('–†–∞—Å–ø–æ–ª–∞–≥–∞—é –Ω–∏–∫–∏ —Å–ø–∏—Ä–∞–ª—å—é:', nicks.length);
        
        if (nicks.length === 0) return;
        
        // –¶–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–ø–∏—Ä–∞–ª–∏
        const angleStep = 2.8;
        const radiusStep = 120;
        let currentRadius = 50;
        let currentAngle = 0;
        
        // –†–∞—Å—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –Ω–∏–∫–∏ –ø–æ —Å–ø–∏—Ä–∞–ª–∏
        nicks.forEach((nick, index) => {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            const x = centerX + Math.cos(currentAngle) * currentRadius - 50;
            const y = centerY + Math.sin(currentAngle) * currentRadius - 20;
            
            // –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
            nick.style.transition = 'left 0.5s ease, top 0.5s ease';
            nick.style.left = x + 'px';
            nick.style.top = y + 'px';
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ
            currentAngle += angleStep;
            currentRadius += radiusStep;
            
            // –£–±–∏—Ä–∞–µ–º transition –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                nick.style.transition = '';
            }, 500);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            updateNickPositionOnServer(nick.dataset.id, x, y);
        });
        
        console.log('–ù–∏–∫–∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –ø–æ —Å–ø–∏—Ä–∞–ª–∏');
    }
    
    // 5. –ì–æ–ª–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
    function createNickHologramAnimation(text, x, y, id) {
        return new Promise((resolve) => {
            // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            const scanEffect = document.createElement('div');
            scanEffect.style.position = 'absolute';
            scanEffect.style.left = x + 'px';
            scanEffect.style.top = y + 'px';
            scanEffect.style.width = '10px';
            scanEffect.style.height = '0';
            scanEffect.style.background = 'linear-gradient(to bottom, transparent, lime, transparent)';
            scanEffect.style.boxShadow = '0 0 30px lime';
            scanEffect.style.zIndex = '1000';
            scanEffect.style.transition = 'height 0.5s ease';
            
            canvas.appendChild(scanEffect);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            setTimeout(() => {
                scanEffect.style.height = '100px';
                
                // –ü–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–µ–º –Ω–∏–∫
                setTimeout(() => {
                    const nickElement = document.createElement('div');
                    nickElement.className = 'nickname hologram';
                    nickElement.textContent = text;
                    nickElement.style.left = x + 'px';
                    nickElement.style.top = y + 'px';
                    nickElement.style.position = 'absolute';
                    nickElement.style.opacity = '0';
                    nickElement.style.transform = 'scale(0.8)';
                    nickElement.style.filter = 'blur(10px)';
                    nickElement.dataset.id = id;
                    
                    canvas.appendChild(nickElement);
                    
                    // –£–¥–∞–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    scanEffect.remove();
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–∏–∫–∞
                    setTimeout(() => {
                        nickElement.style.transition = 'all 0.7s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        nickElement.style.opacity = '1';
                        nickElement.style.transform = 'scale(1)';
                        nickElement.style.filter = 'blur(0px)';
                        
                        // –≠—Ñ—Ñ–µ–∫—Ç "—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏"
                        setTimeout(() => {
                            nickElement.style.transition = '';
                            resolve(nickElement);
                        }, 700);
                    }, 50);
                }, 500);
            }, 100);
        });
    }
    
    // 6. –ó–∞–≥—Ä—É–∑–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function loadNicksFromServer() {
        console.log('–ó–∞–≥—Ä—É–∂–∞—é –Ω–∏–∫–∏...');
        
        try {
            const response = await fetch('/api/get-all-nicks');  // ‚¨ÖÔ∏è –ò–°–ü–†–ê–í–õ–ï–ù–û
            const nicks = await response.json();
            
            console.log('–° —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω–æ:', nicks.length, '–Ω–∏–∫–æ–≤');
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∏–∫–∏
            const oldNicks = document.querySelectorAll('.nickname[data-id^="NICK_"]');
            oldNicks.forEach(nick => nick.remove());
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –Ω–∏–∫–∏ –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
            nicks.forEach(nick => {
                const el = document.createElement('div');
                el.className = 'nickname';
                el.textContent = nick.text;
                el.style.left = '100px';
                el.style.top = '100px';
                el.dataset.id = nick.id;
                canvas.appendChild(el);
            });
            
            // –†–∞—Å—Å—Ç–∞–≤–ª—è–µ–º —Å–ø–∏—Ä–∞–ª—å—é
            setTimeout(() => {
                arrangeNicksInSpiral();
                console.log('–í—Å–µ–≥–æ –Ω–∏–∫–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:', document.querySelectorAll('.nickname').length);
            }, 100);
            
            return nicks.length;
            
        } catch (error) {
            console.log('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error.message);
            return 0;
        }
    }
    
    // 7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –Ω–∏–∫–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    donutButton.addEventListener('click', async function() {
        const nickname = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫:');
        if (!nickname || nickname.trim() === '') return;
        
        const nickId = generateID();
        
        // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        const x = 100;
        const y = 100;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        this.style.display = 'none';
        
        try {
            // –°–æ–∑–¥–∞–µ–º –Ω–∏–∫ —Å –≥–æ–ª–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
            const nickElement = await createNickHologramAnimation(nickname, x, y, nickId);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            await fetch('/api/save-nick', {  // ‚¨ÖÔ∏è –ò–°–ü–†–ê–í–õ–ï–ù–û
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: nickId,
                    text: nickname.trim(),
                    x: x,
                    y: y
                })
            });
            
            console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:', nickId);
            
            // –ü–µ—Ä–µ—Ä–∞—Å—á–µ—Ç —Å–ø–∏—Ä–∞–ª–∏
            setTimeout(() => {
                arrangeNicksInSpiral();
            }, 1000);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    });
    
    // 8. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    window.addEventListener('load', async function() {
        console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∏–∫–∏
        await loadNicksFromServer();
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏–∫–æ–≤ –≤–æ–æ–±—â–µ
        if (document.querySelectorAll('.nickname').length === 0) {
            console.log('–î–æ–±–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤—ã–π –Ω–∏–∫');
            const testNick = document.createElement('div');
            testNick.className = 'nickname';
            testNick.textContent = '–ö–ª–∏–∫–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É ‚Üì';
            testNick.style.left = '500px';
            testNick.style.top = '500px';
            testNick.dataset.id = 'test_' + Date.now();
            canvas.appendChild(testNick);
        }
        
        console.log('–í—Å–µ–≥–æ –Ω–∏–∫–æ–≤:', document.querySelectorAll('.nickname').length);
    });
    </script>
</body>

</html>
